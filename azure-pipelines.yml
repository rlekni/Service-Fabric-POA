trigger:
  branches:
    include:
      - master

variables:
  buildConfiguration: Release
  buildProjects: "**/*.csproj"
  packageProjects: "**/*.sfproj"

jobs:
  - job: build_old
    displayName: Build with ps script
    pool:
      vmImage: vs2017-win2016
    steps:
      - task: PowerShell@2
        displayName: "Build Code"
        inputs:
          targetType: filePath
          filePath: "./build.ps1"
  - job: cibuild
    displayName: cibuild
    pool:
      vmImage: windows-2019
    steps:
      - task: DotNetCoreInstaller@0
        displayName: Install .NET CLI
        inputs:
          version: 2.1.300
      - task: DotNetCoreCLI@2
        displayName: Restore packages (CS Projects)
        inputs:
          command: restore
          feedsToUse: config
          nugetConfigPath: nuget.config
          projects: $(buildProjects)
          noCache: true
          verbosityRestore: Normal
      - task: NuGetCommand@2
        displayName: Restore packages (SF Projects)
        inputs:
          restoreSolution: $(packageProjects)
          restoreDirectory: "../../packages"
          feedsToUse: config
          projects: $(buildProjects)
          noCache: true
          verbosityRestore: Normal
      - task: DotNetCoreCLI@2
        displayName: Build projects
        inputs:
          projects: $(buildProjects)
          packDirectory: $(Build.ArtifactStagingDirectory)
          arguments: "-c $(buildConfiguration) /p:Platform=x64 /p:Version=$(Build.BuildNumber)"
      - task: DotNetCoreCLI@2
        displayName: Package Projects (Publish - Release)
        inputs:
          projects: $(packageProjects)
          packDirectory: $(Build.ArtifactStagingDirectory)/drop/release
          arguments: "-c $(buildConfiguration) /p:Platform=x64 /p:Version=$(Build.BuildNumber) /t:Package /p:PackageLocation=$(Build.ArtifactStagingDirectory)/drop/release/applicationpackage"
      - task: ServiceFabricUpdateManifests@2
        displayName: Update Service Fabric Version (Release)
        inputs:
          applicationPackagePath: $(Build.ArtifactStagingDirectory)/drop/release/applicationpackage
          versionSuffix: $(Build.BuildNumber)
          versionBehaviour: Replace
      - task: CopyFiles@2
        displayName: Copy XML Files to Artifacts (Release)
        inputs:
          SourceFolder: src\
          Contents: |
            **\*.ServiceFabric\PublishProfiles\*.xml
            **\*.ServiceFabric\ApplicationParameters\*.xml
          TargetFolder: $(Build.ArtifactStagingDirectory)/drop/release/projectartifacts
          CleanTargetFolder: true
      - task: PublishBuildArtifacts@1
        displayName: Publish Build artifacts
        inputs:
          pathToPublish: $(Build.ArtifactStagingDirectory)/drop
          artifactName: drop
          publishLocation: Container
